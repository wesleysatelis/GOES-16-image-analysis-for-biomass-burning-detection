library(raster)
library(viridis)
library(tidyverse)
library(geobr)
library(sf)
library(parallel)
coord_crs <- "+proj=longlat +ellps=WGS84"
meter_crs <- "+proj=utm +zone=22S +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"
prc <- function(arq){
c2 <- scan(file = paste0("data/", arq, "C02.txt"), sep = ",", quiet=TRUE)
c2 <- matrix(c2, byrow= TRUE, ncol = 2110, nrow = 1332)
c3 <- scan(file = paste0("data/", arq, "C03.txt"), sep = ",", quiet=TRUE)
c3 <- matrix(c3, byrow= TRUE, ncol = 2110, nrow = 1332)
ndvi <- t(c3-c2)/t(c3+c2)
ndvi_rast <- raster(xmn=-53.4948231956, xmx=-43.9471907179, ymn=-25.4224855885,
ymx=-19.4198207653,  ncols=2110, nrows=1332, crs=coord_crs)
ndvi_rast <- setValues(ndvi_rast, as.vector(ndvi))
ndvi_rast <- flip(ndvi_rast, 2)
ndvi_rast <- projectRaster(ndvi_rast, crs=meter_crs)
plant_buffer <- st_buffer(loc_plant, dis=2000)
for(ponto in 1:nrow(loc_plant)){
rast_raio <- crop(ndvi_rast, filter(plant_buffer, row_number() == ponto))
loc_vals <- tibble::enframe(getValues(rast_raio)) %>%
spread(value = value, key = name) %>%
mutate(data = paste0(str_sub(arq, 1, 4), "-", str_sub(arq, 5, 6), "-",
str_sub(arq, 7, 8), sep=""),
hora=paste0(str_sub(arq, 9, 10), ":", str_sub(arq, 11, 12)))
write_csv(loc_vals, path = paste0("loc", ponto, ".csv"), append = TRUE)
rm(loc_vals)
}
}
set.seed(13)
loc_plant <- read.table("canasat_sp12.txt") %>%
sample_n(10) %>%
st_as_sf(coords = c(2,1), crs=coord_crs) %>%
st_transform(crs = meter_crs)
files_drive <- read_delim("drive_filelist.txt", delim = ' ', col_names = FALSE)
files_drive <- read_delim("drive_filelist.txt", delim = ' ', col_names = FALSE) %>% arrange(X2)
files_drive <- files_drive$X2
files_drive
f <- files_drive[1]
paste("tar xzf", f, "--strip=3")
paste0("tar xzf data/", f, " --strip=3")
library(raster)
library(tidyverse)
library(geobr)
library(sf)
library(parallel)
library(rgdal)
prc <- function(arq){
c2 <- scan(file = paste0("data/", arq, "C02.txt"), sep = ",", quiet = TRUE)
c2 <- matrix(c2, byrow= TRUE, ncol = 2110, nrow = 1332)
c3 <- scan(file = paste0("data/", arq, "C03.txt"), sep = ",", quiet = TRUE)
c3 <- matrix(c3, byrow= TRUE, ncol = 2110, nrow = 1332)
c6 <- scan(file = paste0("data/", arq, "C06.txt"), sep = ",", quiet = TRUE)
c6 <- matrix(c6, byrow= TRUE, ncol = 2110, nrow = 1332)
ndvi <- t(c3-c2)/t(c3+c2)
nbr <- t(c3-c6)/t(c3-c6)
rm(c2, c3, c6)
sv_points(type = "ndvi", values = ndvi, file = arq)
sv_points(type = "nbr", values = nbr, file = arq)
}
coord_crs <- "+proj=longlat +ellps=WGS84"
meter_crs <- "+proj=utm +zone=22S +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"
set.seed(13)
files_drive <- read_delim("drive_filelist.txt", delim = ' ', col_names = FALSE) %>% arrange(X2)
files_drive <- files_drive$X2
sv_points <- function(type, values, file){
rast <- raster(xmn = -53.4948231956, xmx = -43.9471907179, ymn = -25.4224855885,
ymx = -19.4198207653,  ncols = 2110, nrows = 1332, crs = coord_crs)
rast <- setValues(rast, values)
rast <- flip(rast, 2)
rast <- projectRaster(rast, crs=meter_crs)
plant_buffer <- st_buffer(loc_plant, dis = 2000)
for(ponto in 1:nrow(loc_plant)){
rast_raio <- crop(rast, filter(plant_buffer, row_number() == ponto))
loc_vals <- tibble::enframe(getValues(rast_raio)) %>%
spread(value = value, key = name) %>%
mutate(data = paste0(str_sub(file, 1, 4), "-", str_sub(file, 5, 6), "-",
str_sub(file, 7, 8), sep = ""),
hora=paste0(str_sub(file, 9, 10), ":", str_sub(file, 11, 12)))
write_csv(loc_vals, path = paste0(as.character(type), "_loc", ponto, ".csv"), append = TRUE)
}
}
loc_plant <- read.table("canasat_sp12.txt") %>%
sample_n(10) %>%
st_as_sf(coords = c(2,1), crs = coord_crs) %>%
st_transform(crs = meter_crs)
for (f in files_drive){
system(paste0("rclone copy remote:goes_bands/", f, ' ', "data"))
system(paste0("tar xzf data/", f, " --strip=3", " --directory data/"), intern = FALSE, wait = TRUE)
files <- list.files("data", pattern = ".txt") %>%
str_sub(1, 36) %>%
unique()
# mclapply(files, prc, mc.cores = detectCores()-6)
for(i in files) prc(i)
# system(paste("rm data/*"))
break
}
c2 <- scan(file = paste0("data/", arq, "C02.txt"), sep = ",", quiet = TRUE)
c2 <- scan(file = paste0("data/201905180000G16.SP_2_3_6_ascii--L1B.C02.txt"), sep = ",", quiet = TRUE)
c2 <- matrix(c2, byrow= TRUE, ncol = 2110, nrow = 1332)
rast <- raster(xmn = -53.4948231956, xmx = -43.9471907179, ymn = -25.4224855885,
ymx = -19.4198207653,  ncols = 2110, nrows = 1332, crs = coord_crs)
rast <- setValues(rast, c2)
arq <- "201905180000G16.SP_2_3_6_ascii--L1B."
c2 <- scan(file = paste0("data/", arq, "C02.txt"), sep = ",", quiet = TRUE)
c2 <- matrix(c2, byrow= TRUE, ncol = 2110, nrow = 1332)
c3 <- scan(file = paste0("data/", arq, "C03.txt"), sep = ",", quiet = TRUE)
c3 <- matrix(c3, byrow= TRUE, ncol = 2110, nrow = 1332)
c6 <- scan(file = paste0("data/", arq, "C06.txt"), sep = ",", quiet = TRUE)
c6 <- matrix(c6, byrow= TRUE, ncol = 2110, nrow = 1332)
ndvi <- t(c3-c2)/t(c3+c2)
nbr <- t(c3-c6)/t(c3+c6)
rm(c2, c3, c6)
sv_points(type = "ndvi", values = ndvi, file = arq)
rast <- raster(xmn = -53.4948231956, xmx = -43.9471907179, ymn = -25.4224855885,
ymx = -19.4198207653,  ncols = 2110, nrows = 1332, crs = coord_crs)
rast <- setValues(rast, ndvi)
dim(ndvi)
ndcols(ndvi)
ncols(ndvi)
ndvi
arq <- "201905180000G16.SP_2_3_6_ascii--L1B."
prc <- function(arq){
c2 <- scan(file = paste0("data/", arq, "C02.txt"), sep = ",", quiet = TRUE)
c2 <- matrix(c2, byrow= TRUE, ncol = 2110, nrow = 1332)
c3 <- scan(file = paste0("data/", arq, "C03.txt"), sep = ",", quiet = TRUE)
c3 <- matrix(c3, byrow= TRUE, ncol = 2110, nrow = 1332)
c6 <- scan(file = paste0("data/", arq, "C06.txt"), sep = ",", quiet = TRUE)
c6 <- matrix(c6, byrow= TRUE, ncol = 2110, nrow = 1332)
ndvi <- t(c3-c2)/t(c3+c2)
nbr <- t(c3-c6)/t(c3+c6)
rm(c2, c3, c6)
sv_points(type = "ndvi", values = ndvi, file = arq)
sv_points(type = "nbr", values = nbr, file = arq)
}
dir()
detwd()
getwd()
arq <- "201905180000G16.SP_2_3_6_ascii--L1B."
c2 <- scan(file = paste0("data/", arq, "C02.txt"), sep = ",", quiet = TRUE)
c2 <- matrix(c2, byrow= TRUE, ncol = 2110, nrow = 1332)
c3 <- scan(file = paste0("data/", arq, "C03.txt"), sep = ",", quiet = TRUE)
c3 <- matrix(c3, byrow= TRUE, ncol = 2110, nrow = 1332)
c6 <- scan(file = paste0("data/", arq, "C06.txt"), sep = ",", quiet = TRUE)
c6 <- matrix(c6, byrow= TRUE, ncol = 2110, nrow = 1332)
ndvi <- t(c3-c2)/t(c3+c2)
nbr <- t(c3-c6)/t(c3+c6)
rm(c2, c3, c6)
sv_points(type = "ndvi", values = ndvi, file = arq)
sv_points <- function(type, values, file){
rast <- raster(xmn = -53.4948231956, xmx = -43.9471907179, ymn = -25.4224855885,
ymx = -19.4198207653,  ncols = 2110, nrows = 1332, crs = coord_crs)
rast <- setValues(rast, as.vector(values))
rast <- flip(rast, 2)
rast <- projectRaster(rast, crs=meter_crs)
plant_buffer <- st_buffer(loc_plant, dis = 2000)
for(ponto in 1:nrow(loc_plant)){
rast_raio <- crop(rast, filter(plant_buffer, row_number() == ponto))
loc_vals <- tibble::enframe(getValues(rast_raio)) %>%
spread(value = value, key = name) %>%
mutate(data = paste0(str_sub(file, 1, 4), "-", str_sub(file, 5, 6), "-",
str_sub(file, 7, 8), sep = ""),
hora=paste0(str_sub(file, 9, 10), ":", str_sub(file, 11, 12)))
write_csv(loc_vals, path = paste0(as.character(type), "_loc", ponto, ".csv"), append = TRUE)
}
}
sv_points(type = "ndvi", values = ndvi, file = arq)
sv_points(type = "nbr", values = nbr, file = arq)
